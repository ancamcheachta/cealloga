<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/cache.js | cealloga</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Simple microservices on demand"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="cealloga"><meta property="twitter:description" content="Simple microservices on demand"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancamcheachta/cealloga"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/cache.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @desc Exports cache exposing interfaces for compiled `CeallogFunction` source
 * code and metadata.
 * @since 0.2.0
 */
&apos;use strict&apos;;

/**
 * @ignore
 */
const CeallogFunction = require(&apos;./models/CeallogFunction&apos;),
    compileStringSync = require(&apos;./compiler&apos;).compileStringSync;

/**
 * @desc The map in which published, cached functions are stored.  Key is the
 * `CeallogFunction` name, value is an object containing `compiled` (function)
 * and `ceallogFunction` (object) fields.
 * @private
 * @type {Object}
 * @see #cache
 * @since 0.2.0
 */
let _cache = {};

/**
 * @desc The map in which unpublished, cached functions are stored.  Key is the
 * `CeallogFunction` id, value is an object containing `compiled` (function) and
 * `ceallogFunction` (object) fields.
 * @private
 * @type {Object}
 * @see #cache
 * @since 0.2.0
 */
let _idCache = {};

/**
 * @desc Cache functions exported in this module.
 * @since 0.2.0
 */
const cache = {
    /**
     * @desc Adds function and metadata to cache.
     * @param {function} compiled The compiled function.
     * @param {Object} ceallogFunction The object containing ceallogFunction
     * metadata.
     * @since 0.2.0
     */
    add: (compiled, ceallogFunction) =&gt; {
        let key = ceallogFunction.published ? ceallogFunction.name
            :ceallogFunction.id;
        let c = ceallogFunction.published ? _cache : _idCache;
        
        c[key] = {
            compiled: compiled,
            ceallogFunction: ceallogFunction
        };
    },
    /**
     * @desc Queries all `CeallogFunction` entries, compiles them, and adds them
     * to the cache. Called when module is loaded.
     * @since 0.2.0
     */
    init: (callback) =&gt; {
        CeallogFunction.find({}, (err, results) =&gt; {
            if (err) throw err;
            
            results.forEach(ceallogFunction =&gt; {
                ceallogFunction.id = ceallogFunction._id;
                
                delete ceallogFunction.__v;
	            delete ceallogFunction._id;
	            
	            try {
	                let compiled = compileStringSync(ceallogFunction.body);
	                
	                cache.add(compiled, ceallogFunction);
	            } catch(err) {
	                let id = ceallogFunction.id;
	                let name = ceallogFunction.name;
	                
	                console.warn(`Failed to compile/cache \`${name}\` (${id})`);
	                console.warn(err);
	            }
            });
            
            if (callback) {
                callback();
            }
        });
    },
    /**
     * @desc Adds `cache` field to `req`.  Called before any other middlewear on
     * `/code` and `/ceallog` routes.
	 * @param {Object} req Express request object
	 * @param {Object} res Express response object
	 * @param {function} next Function to be called by Express next.
	 * @since 0.2.0
     */
    initRequest: (req, res, next) =&gt; {
        req.cache = {
            add: cache.add,
            getPublished: (name) =&gt; {
                return _cache[name];
            },
            getUnpublished: (id) =&gt; {
                return _idCache[id];
            },
            removePublished: (name) =&gt; {
                return cache.remove(name, true);
            },
            removeUnpublished: (id) =&gt; {
                return cache.remove(id, false);
            },
        };
        
        next();
    },
    /**
     * @desc Removes an entry from the appropriate cache if the key is found.
     * @param {string} key
     * @param {boolean} published
     * @return {boolean} Whether entry was deleted from the cache.
     * @since 0.2.0
     */
    remove: (key, published) =&gt; {
        let c = published ? _cache : _idCache;
        
        if(key in c) {
            delete c[key];
            return true;
        }
        
        return false;
    }
};

module.exports = cache;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
