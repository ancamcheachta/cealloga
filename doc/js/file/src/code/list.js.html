<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/code/list.js | cealloga</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Simple microservices on demand"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="cealloga"><meta property="twitter:description" content="Simple microservices on demand"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancamcheachta/cealloga"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/code/list.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @desc Exports a router for `/code/`, the service to obtain a list of code
 * resources
 * @since 0.1.0
 */
&apos;use strict&apos;;

/**
 * @ignore
 */
const CeallogFunction = require(&apos;../models/CeallogFunction&apos;),
	HttpError = require(&apos;../classes/HttpError&apos;),
	ListError = require(&apos;../classes/ListError&apos;);

/**
 * @desc An object acting like a map where key represents the type of message
 * and the value is a string with the message itself.
 * @since 0.1.0
 */
const messages = {
	MISSING_NAME_PARAMETER:
		&apos;`name` parameter must be included when querying unpublished resources.&apos;
};

/**
 * @desc Used to format mongoose responses prior to sending json response.
 * @param {Object} response mongoose resonse to be formatted.
 * @since 0.1.0
 */
const formatter = response =&gt; {
	response.id = response._id;
	delete response.__v;
	delete response._id;
};

/**
 * @desc Queries code based on query string parameters provided.  If none
 * are provided, the latest results for each ceallog function name is sent.
 * @param {Object} req Express request object
 * @param {Object} res Express response object
 * @param {function} next Function to be called by Express next.
 * @since 0.1.0
 */
const query = (req, res, next) =&gt; {
	let name = req.query.name;
	let published = req.query.published;
	let callback = (err, response) =&gt; {
		/* istanbul ignore if */
		if(err) {
			try {
				throw new ListError(err.name, &apos;INTERNAL_SERVER_ERROR&apos;);
			} catch(e) {
				new HttpError(e).send(res);
			} finally {
				return;
			}
		}
		
		if(response instanceof Array) {
			response.forEach(formatter);
		}
		
		res.json(response);
	};

	if (published != null || name != null) {
		let query;

		if (published == &apos;0&apos;) {
			if (!name) {
				try {
					throw new ListError(
						messages.MISSING_NAME_PARAMETER,
						&apos;MISSING_NAME_PARAMETER&apos;
					);
				} catch (e) {
					new HttpError(e, e.errorType, 400).sendError(res);
				} finally {
					return;
				}
			}

			query = {$and: [{published: false}, {name: name}]};
		} else if (name != null) {
			query = {name: name};
		} else {
			query = {published: true};
		}

		return CeallogFunction.find(query, callback);
	} else {
		// Query latest
		let query = [
			{ $sort: { created_date: -1 } },
			{ $group: {
			    _id: &quot;$name&quot;,
			    ceallogaFunctions: { $push: &quot;$$ROOT&quot; }
			}},
			{ $replaceRoot: {
			    newRoot: { $arrayElemAt: [&quot;$ceallogaFunctions&quot;, 0] }
			}}
		];
		
		CeallogFunction.aggregate(query, callback);
	}
};

module.exports = [query];
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
