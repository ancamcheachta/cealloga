<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/code/unpublish.js | cealloga</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Simple microservices on demand"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="cealloga"><meta property="twitter:description" content="Simple microservices on demand"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancamcheachta/cealloga"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/code/unpublish.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @desc Exports a router for `/code/unpublish/:name`, the service to unpublish
 * the code of a specified name.
 * @since 0.1.0
 */
&apos;use strict&apos;;

/**
 * @ignore
 */
const CeallogFunction = require(&apos;../models/CeallogFunction&apos;),
	dbResultCallback = require(&apos;../mongoose-util&apos;).dbResultCallback,
	HttpError = require(&apos;../classes/HttpError&apos;),
	settings = require(&apos;../settings&apos;),
	UnpublishError = require(&apos;../classes/UnpublishError&apos;);

/**
 * @desc An object acting like a map where key represents the type of message
 * and the value is a string with the message itself.
 * @since 0.1.0
 */
const messages = {
	MISSING_PARAMS: &apos;Required parameters missing.&apos;,
	NON_EXISTING_RESOURCE: &apos;Resource does not exist.&apos;,
	UNKNOWN_UPDATE_ERROR: &apos;Unknown update error.&apos;
};

/**
 * @desc Attempts to find the existing published resource by the name provided.
 * If successful, the result is added to `req.unpublisher.result`.
 * @param {Object} req Express request object
 * @param {Object} res Express response object
 * @param {function} next Function to be called by Express next.
 * @since 0.1.0
 */
const findPublished = (req, res, next) =&gt; {
	let err;

	/* istanbul ignore else */
	if (&apos;name&apos; in req.params) {
		let name = req.params.name;
		let query = {
			$and: [{name: name}, {published: true}]
		};
		
		req.unpublisher = req.unpublisher || {record: null};

		CeallogFunction.findOne(query, (err, result) =&gt; {
			let dbResult = dbResultCallback(req.unpublisher)(err, result);

			if (dbResult.type == &apos;SUCCESS&apos; &amp;&amp; result) {
				req.unpublisher.record = result;

				next();
			} else {
				try {
					throw new UnpublishError(
						messages.NON_EXISTING_RESOURCE,
						&apos;NON_EXISTING_RESOURCE&apos;
					);
				} catch (e) {
					err = new HttpError(e, e.errorType, 404);
					err.sendError(res);
				}
			}
		});
	} else {
		try {
			throw new UnpublishError(messages.MISSING_PARAMS, &apos;MISSING_PARAMS&apos;);
		} catch (e) {
			err = new HttpError(e, e.errorType, 400);
			err.sendError(res);
		}
	}
};

/**
 * @desc Attempts to change published to false and update
 * `req.unpublisher.record`.
 * @param {Object} req Express request object
 * @param {Object} res Express response object
 * @param {function} next Function to be called by Express next.
 * @since 0.1.0
 */
const update = (req, res, next) =&gt; {
	let record = req.unpublisher.record;

	/* istanbul ignore else */
	if (record) {
		CeallogFunction.update(
			{_id: record._id},
			{published: false},
			(err, result) =&gt; {
				let dbResult = dbResultCallback(req.unpublisher)(err, result);
				let innerErr;

				switch (dbResult.type) {
					case &apos;UPDATE_RESULT&apos;:
						break;
					/* istanbul ignore next */
					case &apos;UPDATE_ERROR&apos;:
						innerErr = new UnpublishError(dbResult.message, &apos;UPDATE_ERROR&apos;);
						break;
					/* istanbul ignore next */
					case &apos;VALIDATION_ERROR&apos;:
						innerErr = new UnpublishError(dbResult.message, &apos;VALIDATION_ERROR&apos;);
						break;
					/* istanbul ignore next */
					default:
						innerErr = new UnpublishError(
							dbResult.message,
							&apos;INTERNAL_SERVER_ERROR&apos;
						);
						break;
				}
				
				/* istanbul ignore if */
				if (innerErr != null) {
					try {
						throw innerErr;
					} catch (e) {
						new HttpError(e, e.errorType, dbResult.statusCode).sendError(res);
					}
				} else {
					res.statusCode = 200;
					res.json({
						compiled: record.compiled,
						id: record.id,
						label: record.label,
						name: record.name,
						published: false,
						service: `/${settings.cealloga.api_path}/${
							settings.cealloga.test_path
						}/${record._id}`
					});
				}
			}
		);
	} else {
		try {
			throw new UnpublishError(
				&apos;UNKNOWN_UPDATE_ERROR&apos;,
				messages.UNKNOWN_UPDATE_ERROR
			);
		} catch (e) {
			new HttpError(e).sendError(res);
		}
	}
};

module.exports = [findPublished, update];
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
